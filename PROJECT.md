# Описание проекта

## Название проекта

panoTest - отслеживание положения пользователя веб-камерой для интерактивного взаимодействия (панорамирования/сдвига) с изображением на экране

## Краткое описание

panoTest - это веб-приложение, тестирующее принципиально новый способ взаимодействия пользователя с экраном компьютера: без использования мыши и клавиатуры, только меняя положение своей головы относительно **веб-камеры**, пользователь управляет изменением изображения на экране (панорамирование/сдвиг).

Технология под капотом: MediaPipe отслеживает изменение положения головы (ближе/дальше, вправо/влево, вверх/вниз), и передаёт команду на изменение масштаба/сдвиг статичного **фонового изображения** (далее - **ФИ**). Ширина и высота ФИ в 2-3 раза превышают размеры монитора в пикселях. В начальном состоянии показывается приблизительно 50% ФИ - его средняя часть.

Далее действуют 2 алгоритма:

1. **Алгоритм масштабирования** (приближение/удаление):
   - При плавном приближении пользователя к экрану - плавно увеличивается процент отображения ФИ - 51%, 52% и так далее.
   - JS-алгоритм преобразует линейный декремент **Расстояния от пользователя до монитора** (далее - **РМ**) в нелинейный процент отображения ФИ (см. [Угловой размер](https://ru.wikipedia.org/wiki/%D0%A3%D0%B3%D0%BB%D0%BE%D0%B2%D0%BE%D0%B9_%D1%80%D0%B0%D0%B7%D0%BC%D0%B5%D1%80)).
   - **Угловой размер экрана** (далее - **УРЭ**) по горизонтали вычисляется как: **α = 2 × arctan(W / (2 × L))**, где W — ширина экрана, L — расстояние до наблюдателя (РМ).
   - УРЭ растёт от ~28° (если РМ приблизительно равно 1 диагонали монитора) до практически 180 градусов (когда РМ близко к нулю).
   - На практике нас интересуют **РМ** в диапазоне от 30 см до 1.5 метров при диагонали монитора 27 дюймов (либо 14-15 дюймов в случае ноутбука).
   - Используется MediaPipe Face Landmarker для стабильного head pose (translation X/Y/Z от камеры), Z-translation landmarks используются для **РМ**.

2. **Алгоритм панорамирования** (сдвиг):
   - При сдвиге пользователя влево (экран оказывается правее человека) - масштаб ФИ не меняется, но "окно", показывающее приблизительно 50% ФИ, сдвигается по ФИ вправо.
   - У пользователя создаётся ощущение, что монитор - это окно, а ФИ находится за окном на значительном удалении от пользователя.
   - Аналогично, при движении головы пользователя влево, вверх, вниз - окно смещается в соответствующую сторону.

## Цели проекта

- Испытать новый способ взаимодействия пользователя с экраном без использования традиционных устройств ввода (мышь, клавиатура)
- Создать прототип интуитивного интерфейса, управляемого движением головы
- Проверить техническую реализуемость концепции "окна в виртуальный мир"
- Достичь плавного взаимодействия с минимальной задержкой (~30 FPS обработки видео)

## Целевая аудитория

- Разработчики и энтузиасты, интересующиеся инновационными способами взаимодействия с веб-приложениями
- Потенциальные пользователи для тестирования и обратной связи
- В будущем - возможно применение в образовательных и развлекательных проектах

## Технологический стек

- **Frontend**: Чистый JavaScript (ES6+), без фреймворков на MVP
- **Computer Vision**: MediaPipe Face Landmarker (через @mediapipe/face_mesh или @mediapipe/tasks-vision)
- **3D/Graphics** (планируется): Three.js для отображения частиц (снежинки) на фоне ФИ
- **Backend**: Не требуется (MVP - полностью фронтенд приложение)

## Архитектура (высокоуровневая)

Приложение работает полностью в браузере без серверной части:

```
┌─────────────────────────────────────────┐
│           Браузер пользователя          │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────────────────────────┐ │
│  │   WebRTC API (камера)             │ │
│  │   ↓                               │ │
│  │   Video Stream                    │ │
│  └─────────────┬─────────────────────┘ │
│                ↓                        │
│  ┌───────────────────────────────────┐ │
│  │   MediaPipe Face Landmarker       │ │
│  │   - Head Pose Tracking            │ │
│  │   - Translation X/Y/Z             │ │
│  └─────────────┬─────────────────────┘ │
│                ↓                        │
│  ┌───────────────────────────────────┐ │
│  │   Head Tracking Controller        │ │
│  │   - Преобразование pose → РМ      │ │
│  │   - Расчёт УРЭ (угловой размер)   │ │
│  │   - Маппинг РМ → % отображения ФИ │ │
│  └─────────────┬─────────────────────┘ │
│                ↓                        │
│  ┌───────────────────────────────────┐ │
│  │   Viewport Manager                │ │
│  │   - Управление масштабом          │ │
│  │   - Управление позицией viewport  │ │
│  │   - Рендеринг ФИ на canvas        │ │
│  └─────────────┬─────────────────────┘ │
│                ↓                        │
│  ┌───────────────────────────────────┐ │
│  │   Canvas/Canvas 2D API            │ │
│  │   (или Three.js в будущем)        │ │
│  └───────────────────────────────────┘ │
│                                         │
└─────────────────────────────────────────┘
```

## Основные компоненты

### 1. Camera Manager (camera-manager.js)
- Инициализация доступа к веб-камере через WebRTC API
- Управление разрешением и FPS видео-потока
- Обработка ошибок доступа к камере

### 2. MediaPipe Handler (mediapipe-handler.js)
- Загрузка и инициализация MediaPipe Face Landmarker
- Обработка каждого кадра видео
- Извлечение head pose (translation X/Y/Z)
- Фильтрация и сглаживание данных для стабильности

### 3. Head Tracking Controller (head-tracking-controller.js)
- Преобразование Z-translation в РМ (расстояние до монитора)
- Расчёт углового размера экрана (УРЭ) по формуле: α = 2 × arctan(W / (2 × L))
- Маппинг РМ в процент отображения ФИ (нелинейное преобразование)
- Обработка смещения головы по X/Y для панорамирования

### 4. Viewport Manager (viewport-manager.js)
- Управление текущим viewport (какая часть ФИ показывается)
- Расчёт масштаба на основе процента отображения
- Расчёт позиции viewport на основе смещения головы
- Применение трансформаций к рендерингу

### 5. Image Renderer (image-renderer.js)
- Загрузка фонового изображения (ФИ)
- Рендеринг ФИ на canvas с учётом текущего viewport
- Оптимизация производительности (requestAnimationFrame)

### 6. UI Controller (ui-controller.js)
- Управление интерфейсом (кнопки старт/стоп, статус)
- Отображение версии и билда в статус-баре
- Обработка пользовательских действий

### 7. Performance Monitor (performance-monitor.js) - опционально
- Мониторинг FPS обработки видео
- Отображение метрик производительности

## Планируемые функции (MVP)

### Фаза 1: Базовая функциональность
- [ ] Доступ к веб-камере через браузер
- [ ] Интеграция MediaPipe Face Landmarker
- [ ] Отслеживание head pose (translation X/Y/Z)
- [ ] Преобразование Z-translation в РМ
- [ ] Загрузка и отображение фонового изображения (ФИ) - захардкожено для MVP
- [ ] Базовый рендеринг ФИ на canvas (начальное состояние - 50% центральной части)

### Фаза 2: Алгоритм масштабирования
- [ ] Реализация формулы углового размера экрана (УРЭ)
- [ ] Нелинейное преобразование РМ → % отображения ФИ
- [ ] Плавное изменение масштаба при приближении/удалении
- [ ] Калибровка диапазона РМ (30 см - 1.5 м)

### Фаза 3: Алгоритм панорамирования
- [ ] Обработка смещения головы по X (влево/вправо)
- [ ] Обработка смещения головы по Y (вверх/вниз)
- [ ] Сдвиг viewport по ФИ при движении головы
- [ ] Ограничение границ viewport (чтобы не выйти за пределы ФИ)

### Фаза 4: Полировка и оптимизация
- [ ] Сглаживание движений (фильтрация jitter)
- [ ] Достижение стабильных ~30 FPS обработки видео
- [ ] Отображение версии приложения и билда в статус-баре
- [ ] Обработка ошибок (отсутствие камеры, ошибки MediaPipe)
- [ ] Базовая документация и комментарии в коде

## Будущие улучшения (после MVP)

### Фаза 5: Three.js интеграция
- [ ] Интеграция Three.js для рендеринга
- [ ] Система частиц (снежинки) на фоне ФИ
- [ ] Velocity частиц от head delta движения
- [ ] Визуальные эффекты и анимации

### Фаза 6: Расширенная функциональность
- [ ] Загрузка пользовательских фоновых изображений
- [ ] Настройка параметров (чувствительность, диапазон РМ)
- [ ] Калибровка под разные размеры экранов
- [ ] Поддержка 2-3 одновременно подключённых мониторов - потребуется первоначальная настройка их размеров и взаимного расположения
- [ ] Сохранение настроек в localStorage
- [ ] Поддержка нескольких предустановленных ФИ
- [ ] Режим "калибровки" для настройки под конкретного пользователя

### Фаза 7: UX улучшения
- [ ] Инструкции для первого запуска
- [ ] Визуальная индикация отслеживания головы
- [ ] Режим отладки с отображением метрик (FPS, РМ, УРЭ)
- [ ] Настройки производительности (качество vs скорость)

## Ограничения и требования

### Технические требования
- **Браузер**: Современные браузеры с поддержкой WebRTC и WebGL (Chrome 90+, Firefox 88+, Edge 90+)
- **Камера**: Веб-камера с разрешением минимум 640x480
- **Производительность**: Поддержка обработки видео на ~30 FPS
- **Разрешения**: Доступ к веб-камере (требуется разрешение пользователя)

### Ограничения
- Работает только в браузерах с поддержкой WebRTC API
- Требуется хорошее освещение для стабильного отслеживания лица
- Точность отслеживания зависит от качества камеры
- Не работает при отсутствии лица в кадре
- Фоновое изображение захардкожено для MVP (планируется загрузка пользователем в будущем)

### Математические параметры
- **Диапазон РМ**: 30 см - 1.5 метра
- **Диагональ монитора**: 27 дюймов (или 14-15 дюймов для ноутбука)
- **УРЭ при РМ = 1 диагональ**: ~28°
- **УРЭ при РМ → 0**: до ~180°
- **Размер ФИ**: 2-3× размер экрана в пикселях
- **Начальный % отображения ФИ**: ~50% (центральная часть)

## Структура проекта (предполагаемая)

```
pano/
├── index.html                 # Главная HTML страница
├── package.json               # Зависимости проекта
├── README.md                  # Документация проекта
├── REQUIREMENTS.md            # Требования
├── PROJECT.md                 # Описание проекта
├── RULES.md                   # Правила разработки
├── src/
│   ├── main.js                # Точка входа приложения
│   ├── camera/
│   │   └── camera-manager.js  # Управление камерой
│   ├── mediapipe/
│   │   └── mediapipe-handler.js # Обработка MediaPipe
│   ├── tracking/
│   │   └── head-tracking-controller.js # Логика отслеживания
│   ├── viewport/
│   │   └── viewport-manager.js # Управление viewport
│   ├── renderer/
│   │   └── image-renderer.js  # Рендеринг изображения
│   ├── ui/
│   │   └── ui-controller.js   # Управление UI
│   └── utils/
│       ├── math-utils.js      # Математические утилиты (УРЭ, маппинг)
│       └── version.js         # Версия и билд
├── assets/
│   └── images/
│       └── background.jpg     # Фоновое изображение (для MVP)
└── styles/
    └── main.css               # Стили приложения
```
